<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriMoist Pro - Smart Agriculture Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#2F855A',
                        'primary-dark': '#276749',
                        secondary: '#3182CE',
                        'dark-bg': '#1A202C',
                        'dark-panel': '#2D3748'
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        [x-cloak] { display: none !important; }
        .chart-container { @apply bg-white dark:bg-dark-panel p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700; }
        .data-card { @apply bg-white dark:bg-dark-panel p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow border border-gray-100 dark:border-gray-700; }
        .loading-spinner { @apply animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent; }
        .leaflet-container { @apply bg-gray-50 dark:bg-dark-panel; }
    </style>
</head>
<body x-data="app()" x-init="initApp()" x-cloak class="font-inter bg-gray-50 dark:bg-dark-bg text-gray-800 dark:text-gray-200">
    <!-- Loading Overlay -->
    <div x-show="isLoading" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="loading-spinner"></div>
    </div>

    <!-- Sidebar -->
    <aside class="fixed inset-y-0 left-0 w-64 bg-white dark:bg-dark-panel shadow-xl flex flex-col">
        <div class="p-6 border-b border-gray-100 dark:border-gray-700">
            <h1 class="text-xl font-bold flex items-center space-x-2">
                <span class="text-primary">🌱</span>
                <span>AgriMoist Pro</span>
            </h1>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <template x-for="(navItem, index) in navItems" :key="index">
                <button @click="currentView = navItem.id" 
                        :class="currentView === navItem.id ? 'bg-primary/10 text-primary' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'"
                        class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors">
                    <span x-text="navItem.emoji"></span>
                    <span x-text="navItem.label"></span>
                    <span x-show="navItem.id === 'zones' && hasCriticalAlert()" class="ml-auto w-2 h-2 bg-red-500 rounded-full"></span>
                </button>
            </template>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="ml-64 p-8">
        <!-- Dashboard Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 space-y-4 md:space-y-0">
            <div>
                <h2 class="text-2xl font-bold" x-text="currentViewLabel"></h2>
                <p class="text-gray-500 dark:text-gray-400" x-text="currentViewDescription"></p>
            </div>
            <div class="flex items-center space-x-4">
                <button @click="toggleTheme()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <span x-text="isDark ? '🌞' : '🌙'"></span>
                </button>
                <button @click="fetchZones()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    🔄 Actualiser
                </button>
            </div>
        </div>

        <!-- Dashboard View -->
        <template x-if="currentView === 'dashboard'">
            <div class="space-y-8">
                <!-- Status Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="data-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Zones Actives</p>
                                <p class="text-3xl font-bold" x-text="zones.length"></p>
                            </div>
                            <div class="p-3 bg-primary/10 rounded-lg">
                                <span class="text-2xl">🌾</span>
                            </div>
                        </div>
                    </div>
                    <div class="data-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Humidité Moyenne</p>
                                <p class="text-3xl font-bold" x-text="`${averageMoisture.toFixed(1)}%`"></p>
                            </div>
                            <div class="p-3 bg-blue-100 dark:bg-blue-900 rounded-lg">
                                <span class="text-2xl">💧</span>
                            </div>
                        </div>
                    </div>
                    <div class="data-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Alertes Actives</p>
                                <p class="text-3xl font-bold" x-text="criticalZones.length + warningZones.length"></p>
                            </div>
                            <div class="p-3 bg-red-100 dark:bg-red-900 rounded-lg">
                                <span class="text-2xl">⚠️</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Chart -->
                <div class="chart-container">
                    <h3 class="text-lg font-semibold mb-4">Tendance d'Humidité</h3>
                    <div id="mainChart" class="h-96"></div>
                </div>
            </div>
        </template>

        <!-- Zones Management -->
        <template x-if="currentView === 'zones'">
            <div class="space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
                    <div class="flex items-center space-x-4">
                        <input x-model="searchQuery" type="text" placeholder="Rechercher..." 
                               class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-dark-panel">
                        <select x-model="selectedSort" class="px-4 py-2 border rounded-lg dark:bg-dark-panel">
                            <option value="moisture_desc">Humidité ↓</option>
                            <option value="moisture_asc">Humidité ↑</option>
                        </select>
                    </div>
                    <button @click="openModal('addZone')" 
                            class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition flex items-center space-x-2">
                        <span>➕</span>
                        <span>Ajouter Zone</span>
                    </button>
                </div>

                <!-- Zones Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <template x-for="zone in filteredZones" :key="zone.id">
                        <div class="data-card group relative">
                            <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded-xl"></div>
                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="text-xl font-semibold" x-text="zone.name"></h3>
                                        <p class="text-sm text-gray-500" x-text="zone.location"></p>
                                    </div>
                                    <span :class="`w-3 h-3 rounded-full ${statusColor(zone.moisture)}`"></span>
                                </div>
                                <div class="mb-6">
                                    <p class="text-4xl font-bold mb-2" x-text="`${zone.moisture}%`"></p>
                                    <div class="flex items-center space-x-2 text-sm text-gray-500">
                                        <span>🕒</span>
                                        <span x-text="new Date(zone.lastUpdate).toLocaleString()"></span>
                                    </div>
                                </div>
                                <div :id="`chart-${zone.id}`" class="h-24"></div>
                                <div class="mt-4 flex space-x-2">
                                    <button @click="openModal('editZone', zone)" class="text-sm px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-lg">✏️ Modifier</button>
                                    <button @click="deleteZone(zone.id)" class="text-sm px-3 py-1 bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-300 rounded-lg">🗑️ Supprimer</button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <!-- Analytics View -->
        <template x-if="currentView === 'analytics'">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="chart-container">
                    <h3 class="text-lg font-semibold mb-4">Répartition par Statut</h3>
                    <div id="pieChart" class="h-80"></div>
                </div>
                <div class="chart-container">
                    <h3 class="text-lg font-semibold mb-4">Historique des Mesures</h3>
                    <div id="lineChart" class="h-80"></div>
                </div>
                <div class="chart-container lg:col-span-2">
                    <h3 class="text-lg font-semibold mb-4">Comparaison des Zones</h3>
                    <div id="barChart" class="h-96"></div>
                </div>
            </div>
        </template>

        <!-- Map View -->
        <template x-if="currentView === 'map'">
            <div class="chart-container p-0 overflow-hidden">
                <div id="map" class="h-[600px] rounded-xl"></div>
            </div>
        </template>

        <!-- Modals -->
        <template x-if="modalOpen">
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity">
                <div class="bg-white dark:bg-dark-panel p-6 rounded-xl shadow-2xl w-full max-w-md" @click.away="closeModal()">
                    <h3 class="text-xl font-semibold mb-4" x-text="modalTitle"></h3>
                    <div class="space-y-4">
                        <template x-if="modalType === 'addZone' || modalType === 'editZone'">
                            <div class="space-y-4">
                                <input type="text" placeholder="Nom de la zone" 
                                       class="w-full p-2 border rounded-lg dark:bg-dark-bg" 
                                       x-model="modalData.name">
                                <input type="number" placeholder="Humidité initiale" 
                                       class="w-full p-2 border rounded-lg dark:bg-dark-bg" 
                                       x-model.number="modalData.moisture">
                                <input type="text" placeholder="Localisation" 
                                       class="w-full p-2 border rounded-lg dark:bg-dark-bg" 
                                       x-model="modalData.location">
                                <button @click="saveZone()" 
                                        class="w-full py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition">
                                    Enregistrer
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>

        <!-- Toast Notifications -->
        <div class="fixed bottom-4 right-4 space-y-2 z-50">
            <template x-for="(toast, index) in toasts" :key="index">
                <div :class="`flex items-center p-4 rounded-lg shadow-lg ${toastColor(toast.type)} text-white`" 
                     x-init="setTimeout(() => removeToast(index), 3000)">
                    <span x-text="toastIcon(toast.type)" class="mr-2"></span>
                    <span x-text="toast.message"></span>
                </div>
            </template>
        </div>
    </main>

    <script>
        function app() {
            return {
                // Application State
                isLoading: true,
                currentView: 'dashboard',
                searchQuery: '',
                selectedSort: 'moisture_desc',
                zones: [],
                thresholds: { warning: 40, critical: 30 },
                isDark: localStorage.getItem('theme') === 'dark',
                toasts: [],
                modalOpen: false,
                modalType: '',
                modalTitle: '',
                modalData: {},
                map: null,

                // Navigation Configuration
                navItems: [
                    { id: 'dashboard', label: 'Dashboard', emoji: '📊', description: 'Vue globale des mesures' },
                    { id: 'zones', label: 'Zones', emoji: '🌾', description: 'Gestion des zones agricoles' },
                    { id: 'analytics', label: 'Analytics', emoji: '📈', description: 'Analyse approfondie des données' },
                    { id: 'map', label: 'Carte', emoji: '🗺️', description: 'Visualisation géographique' }
                ],

                // Computed Properties
                get currentViewLabel() {
                    return this.navItems.find(item => item.id === this.currentView)?.label || '';
                },
                get currentViewDescription() {
                    return this.navItems.find(item => item.id === this.currentView)?.description || '';
                },
                get averageMoisture() {
                    return this.zones.reduce((acc, zone) => acc + zone.moisture, 0) / this.zones.length || 0;
                },
                get criticalZones() {
                    return this.zones.filter(z => z.moisture <= this.thresholds.critical);
                },
                get warningZones() {
                    return this.zones.filter(z => z.moisture > this.thresholds.critical && z.moisture <= this.thresholds.warning);
                },
                get filteredZones() {
                    return this.zones
                        .filter(z => z.name.toLowerCase().includes(this.searchQuery.toLowerCase()))
                        .sort((a, b) => this.selectedSort === 'moisture_asc' ? a.moisture - b.moisture : b.moisture - a.moisture);
                },

                // Initialization
                async initApp() {
                    document.documentElement.classList.toggle('dark', this.isDark);
                    await this.fetchZones();
                    this.initializeCharts();
                    this.setupAutoRefresh();
                },

                // API Integration
                async fetchZones() {
                    this.isLoading = true;
                    try {
                        // Simulated API call with mock data
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        this.zones = Array.from({ length: 6 }, (_, i) => ({
                            id: i + 1,
                            name: `Zone ${i + 1}`,
                            moisture: Math.floor(Math.random() * 100),
                            location: `Secteur ${String.fromCharCode(65 + i)}`,
                            lastUpdate: Date.now() - Math.floor(Math.random() * 100000000),
                            history: Array.from({ length: 12 }, () => Math.floor(Math.random() * 100)),
                            coordinates: [48.8584 + Math.random() * 0.1, 2.2945 + Math.random() * 0.1]
                        }));
                    } catch (error) {
                        this.notify('error', 'Erreur de chargement des données');
                    } finally {
                        this.isLoading = false;
                    }
                },

                // Theme Management
                toggleTheme() {
                    this.isDark = !this.isDark;
                    localStorage.setItem('theme', this.isDark ? 'dark' : 'light');
                    document.documentElement.classList.toggle('dark', this.isDark);
                },

                // Zone Management
                openModal(type, zone = {}) {
                    this.modalType = type;
                    this.modalTitle = type === 'addZone' ? 'Ajouter Zone' : 'Modifier Zone';
                    this.modalData = { ...zone };
                    this.modalOpen = true;
                },

                closeModal() {
                    this.modalOpen = false;
                    this.modalData = {};
                },

                async saveZone() {
                    try {
                        if (this.modalType === 'addZone') {
                            const newZone = {
                                ...this.modalData,
                                id: Date.now(),
                                lastUpdate: Date.now(),
                                history: Array.from({ length: 12 }, () => Math.floor(Math.random() * 100)),
                                coordinates: [48.8584 + Math.random() * 0.1, 2.2945 + Math.random() * 0.1]
                            };
                            this.zones.push(newZone);
                        } else {
                            const index = this.zones.findIndex(z => z.id === this.modalData.id);
                            this.zones[index] = { ...this.zones[index], ...this.modalData };
                        }
                        this.notify('success', 'Zone sauvegardée avec succès');
                        this.closeModal();
                    } catch (error) {
                        this.notify('error', 'Erreur de sauvegarde');
                    }
                },

                deleteZone(id) {
                    this.zones = this.zones.filter(z => z.id !== id);
                    this.notify('warning', 'Zone supprimée');
                },

                // Chart Initialization
                initializeCharts() {
                    if (this.currentView === 'dashboard') this.createMainChart();
                    if (this.currentView === 'zones') this.zones.forEach(z => this.createZoneSparkline(z));
                    if (this.currentView === 'analytics') {
                        this.createPieChart();
                        this.createLineChart();
                        this.createBarChart();
                    }
                    if (this.currentView === 'map' && !this.map) this.initializeMap();
                },

                // D3 Chart Implementations
                createMainChart() {
                    const data = this.zones.flatMap(zone => 
                        zone.history.map((value, index) => ({
                            zone: zone.name,
                            value,
                            timestamp: new Date(Date.now() - (zone.history.length - index) * 60000)
                        }))
                    );

                    const margin = { top: 20, right: 30, bottom: 30, left: 40 };
                    const width = document.getElementById('mainChart').clientWidth - margin.left - margin.right;
                    const height = 384 - margin.top - margin.bottom;

                    d3.select('#mainChart').html('');

                    const svg = d3.select('#mainChart')
                        .append('svg')
                        .attr('width', width + margin.left + margin.right)
                        .attr('height', height + margin.top + margin.bottom)
                        .append('g')
                        .attr('transform', `translate(${margin.left},${margin.top})`);

                    const x = d3.scaleTime()
                        .domain(d3.extent(data, d => d.timestamp))
                        .range([0, width]);

                    const y = d3.scaleLinear()
                        .domain([0, 100])
                        .range([height, 0]);

                    const color = d3.scaleOrdinal()
                        .domain(this.zones.map(z => z.name))
                        .range(d3.schemeCategory10);

                    svg.append('g')
                        .call(d3.axisLeft(y));

                    svg.append('g')
                        .attr('transform', `translate(0,${height})`)
                        .call(d3.axisBottom(x));

                    const line = d3.line()
                        .x(d => x(d.timestamp))
                        .y(d => y(d.value));

                    this.zones.forEach(zone => {
                        const zoneData = data.filter(d => d.zone === zone.name);
                        svg.append('path')
                            .datum(zoneData)
                            .attr('fill', 'none')
                            .attr('stroke', color(zone.name))
                            .attr('stroke-width', 2)
                            .attr('d', line);
                    });
                },

                createZoneSparkline(zone) {
                    const element = document.getElementById(`chart-${zone.id}`);
                    if (!element) return;

                    const width = element.clientWidth;
                    const height = element.clientHeight;
                    const margin = { top: 5, right: 5, bottom: 5, left: 5 };

                    const svg = d3.select(element)
                        .html('')
                        .append('svg')
                        .attr('width', width)
                        .attr('height', height);

                    const x = d3.scaleLinear()
                        .domain([0, zone.history.length - 1])
                        .range([margin.left, width - margin.right]);

                    const y = d3.scaleLinear()
                        .domain([0, 100])
                        .range([height - margin.bottom, margin.top]);

                    const area = d3.area()
                        .x((d, i) => x(i))
                        .y0(y(0))
                        .y1(d => y(d));

                    svg.append('path')
                        .datum(zone.history)
                        .attr('d', area)
                        .attr('fill', this.statusColor(zone.moisture) + '20')
                        .attr('stroke', this.statusColor(zone.moisture))
                        .attr('stroke-width', 1);
                },

                createPieChart() {
                    const data = [
                        { label: 'Critique', value: this.criticalZones.length },
                        { label: 'Avertissement', value: this.warningZones.length },
                        { label: 'Normal', value: this.zones.length - this.criticalZones.length - this.warningZones.length }
                    ];

                    const width = 400, height = 400, radius = Math.min(width, height) / 2;
                    const color = d3.scaleOrdinal()
                        .domain(data.map(d => d.label))
                        .range(['#EF4444', '#F59E0B', '#10B981']);

                    const pie = d3.pie().value(d => d.value);
                    const arc = d3.arc().innerRadius(0).outerRadius(radius);

                    d3.select('#pieChart').html('');

                    const svg = d3.select('#pieChart')
                        .append('svg')
                        .attr('width', width)
                        .attr('height', height)
                        .append('g')
                        .attr('transform', `translate(${width/2},${height/2})`);

                    svg.selectAll('path')
                        .data(pie(data))
                        .enter()
                        .append('path')
                        .attr('d', arc)
                        .attr('fill', d => color(d.data.label))
                        .attr('stroke', 'white')
                        .attr('stroke-width', 2);
                },

                // Map Initialization
                initializeMap() {
                    if (!this.map) {
                        this.map = L.map('map').setView([48.8584, 2.2945], 6);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);
                    }

                    this.zones.forEach(zone => {
                        L.marker(zone.coordinates)
                            .addTo(this.map)
                            .bindPopup(`<b>${zone.name}</b><br>Humidité: ${zone.moisture}%`);
                    });
                },

                // Notifications
                notify(type, message) {
                    this.toasts.push({ type, message });
                },

                removeToast(index) {
                    this.toasts.splice(index, 1);
                },

                toastColor(type) {
                    return {
                        success: 'bg-green-500',
                        warning: 'bg-yellow-500',
                        error: 'bg-red-500'
                    }[type];
                },

                toastIcon(type) {
                    return {
                        success: '✅',
                        warning: '⚠️',
                        error: '❌'
                    }[type];
                },

                // Utilities
                statusColor(moisture) {
                    if (moisture <= this.thresholds.critical) return '#EF4444';
                    if (moisture <= this.thresholds.warning) return '#F59E0B';
                    return '#10B981';
                },

                hasCriticalAlert() {
                    return this.criticalZones.length > 0;
                },

                setupAutoRefresh() {
                    setInterval(() => {
                        this.zones = this.zones.map(z => ({
                            ...z,
                            moisture: Math.max(0, z.moisture + (Math.random() * 10 - 5)),
                            lastUpdate: Date.now(),
                            history: [...z.history.slice(1), Math.floor(Math.random() * 100)]
                        }));
                        this.initializeCharts();
                    }, 10000);
                }
            };
        }
    </script>
</body>
</html>